<div class="d-flex flex-column" style="height: 100%;">
    <!-- Textarea section -->
    <div style="flex: 0 0 70%; position: relative;">
        <textarea id="processing-log"
                  class="form-control h-100"
                  style="resize: none;"></textarea>
        <button id="run-button"
                class="btn btn-primary"
                style="position: absolute; top: 8px; right: 8px; display: none;">
            Run
        </button>
    </div>

    <!-- Updates section -->
    <div class="card" style="flex: 0 0 30%; overflow: hidden;">
        <div class="card-header">Status Updates</div>
        <div class="card-body" style="overflow-y: auto;">
            <ul id="updates-list" class="list-unstyled mb-0"></ul>
        </div>
    </div>
</div>

<script>
    const textarea = document.getElementById("processing-log");
    const runButton = document.getElementById("run-button");
    let lastServerContent = "";

    // Helper to show/hide
    function updateRunButtonVisibility() {
        if (textarea.value !== lastServerContent) {
            runButton.style.display = "block";
        } else {
            runButton.style.display = "none";
        }
    }

    // WebSocket for status updates
    const status_ws = new WebSocket(`${wsProtocol}://${window.location.host}/ws/status`);
    status_ws.onmessage = (event) => {
        console.log("Received status update:", event.data);
        const updatesList = document.getElementById("updates-list");

        try {
            const data = JSON.parse(event.data);  // Parse incoming JSON
            const who = data.source || "unknown";
            const message = data.message || "";

            // Create new list item
            const li = document.createElement("li");
            li.innerHTML = `<strong>${who}:</strong> ${message}`;

            // Append to list
            updatesList.appendChild(li);

            // Scroll to bottom of updates panel
            updatesList.parentElement.scrollTop = updatesList.parentElement.scrollHeight;

        } catch (e) {
            console.error("Invalid status update:", event.data);
        }
    };

    // Updates to builder panel
    window.addEventListener('message', (event) => {
        if (event.data.method === "to_builder") {
            console.log('Builder panel message:', event.data);
            lastServerContent = event.data.body;
            textarea.value = event.data.body;
            updateRunButtonVisibility();   // hide, since in-sync
        }
    });

    // Detect user edits
    textarea.addEventListener("input", updateRunButtonVisibility);

    // On “Run”, POST the current text to builder
    runButton.addEventListener("click", () => {

        const chat = document.getElementById('chainlit');
        if (chat) {
            const prompt = {
                method: "to_builder",
                body: "This is the final prompt. Just process it. I will not answer any questions: " + textarea.value
            };
            chat.contentWindow.postMessage(prompt, '*');
            lastServerContent = textarea.value;
            updateRunButtonVisibility();
        }
    });

</script>
