<div class="d-flex flex-column" style="height: 100%;">
    <!-- Textarea section -->
    <div class="position-relative flex-grow-1" style="flex-basis: 70%;">
    <textarea id="processing-log"
              class="form-control h-100"
              style="resize: none;"></textarea>

        <button id="run-button"
                class="btn btn-primary"
                style="position: absolute; top: 8px; right: 8px; display: none;">
            Run
        </button>
    </div>

    <!-- Updates section -->
    <div class="card flex-grow-1" style="flex-basis: 30%; overflow: hidden;">
        <div class="card-header">Status Updates</div>
        <div class="card-body" style="overflow-y: auto;">
            <ul id="updates-list" class="list-unstyled mb-0">
                <li><strong>builder:</strong> Started task 1</li>
                <li><strong>generator:</strong> received task 1</li>
                <li><strong>generator:</strong> completed task 1</li>
                <li><strong>builder:</strong> Started task 1</li>
            </ul>
        </div>
    </div>
</div>

<script>
    const textarea = document.getElementById("processing-log");
    const runButton = document.getElementById("run-button");
    let lastServerContent = "";

    // Helper to show/hide
    function updateRunButtonVisibility() {
        if (textarea.value !== lastServerContent) {
            runButton.style.display = "block";
        } else {
            runButton.style.display = "none";
        }
    }

    // WebSocket for builder text
    let processing_ws = new WebSocket("{{ socket_server }}/ws/processing");
    processing_ws.onmessage = (event) => {
        lastServerContent = event.data;
        textarea.value = event.data;
        updateRunButtonVisibility();   // hide, since in-sync
    };

    // Detect user edits
    textarea.addEventListener("input", updateRunButtonVisibility);

    // On “Run”, POST the current text to builder
    runButton.addEventListener("click", () => {
        fetch("/agent/builder/run", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({body: textarea.value})
        })
            .then(res => {
                if (!res.ok) throw new Error(res.statusText);
                lastServerContent = textarea.value;
                updateRunButtonVisibility();
            })
            .catch(err => {
                console.error(err);
                alert("Failed to run: " + err.message);
            });
    });

</script>
