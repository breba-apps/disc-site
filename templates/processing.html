<div class="position-relative">
  <textarea id="processing-log"
            class="form-control"
            rows="30"></textarea>

    <button id="run-button"
            class="btn btn-primary"
            style="position: absolute; top: 8px; right: 8px; display: none;">
        Run
    </button>
</div>

<script>
    const textarea = document.getElementById("processing-log");
    const runButton = document.getElementById("run-button");
    let lastServerContent = "";

    // Helper to show/hide
    function updateRunButtonVisibility() {
        if (textarea.value !== lastServerContent) {
            runButton.style.display = "block";
        } else {
            runButton.style.display = "none";
        }
    }

    // 1) Wire up your WebSocket
    let processing_ws = new WebSocket("{{ socket_server }}/ws/processing");
    processing_ws.onmessage = (event) => {
        lastServerContent = event.data;
        textarea.value = event.data;
        updateRunButtonVisibility();   // hide, since in-sync
    };

    // 2) Detect user edits
    textarea.addEventListener("input", updateRunButtonVisibility);

    // 3) On “Run”, POST the current text
    runButton.addEventListener("click", () => {
        fetch("/agent/builder/run", {              // <-- singular “agent”, to match your decorator
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({body: textarea.value})
        })
            .then(res => {
                if (!res.ok) throw new Error(res.statusText);
                lastServerContent = textarea.value;
                updateRunButtonVisibility();
            })
            .catch(err => {
                console.error(err);
                alert("Failed to run: " + err.message);
            });
    });

</script>
